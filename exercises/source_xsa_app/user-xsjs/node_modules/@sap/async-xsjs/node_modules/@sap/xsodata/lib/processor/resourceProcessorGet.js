'use strict';

var async = require('async');

var utils = require('./../utils/utils');
var dataCollectorGet = require('./../sql/dataCollectorGet');
var serializer = require('./../serializer/serializer');
var sqlGet = require('./../sql/createGetStatements');

exports.process = function (context, asyncDone) {
    context.logger.silly('resourceprocessor', 'process_GET');


    async.waterfall(
        [
            utils.injectContext(context),
            utils.tryAndMeasure(sqlGet.createGetSqlStatements, 'sqlGet.createGetSqlStatements'),
            utils.tryAndMeasure(dataCollectorGet.createTmpTables, 'dataCollectorGet.createTmpTables'), //create //NEW ORL
            utils.tryAndMeasure(dataCollectorGet.insertFillTmpTables, 'dataCollectorGet.insertFillTmpTables'),
            utils.tryAndMeasure(dataCollectorGet.select, 'dataCollectorGet.select'),

            // truncate temporary tables to clean the session
            utils.try(dataCollectorGet.truncateTempTables),

            // drop temporary tables to clean the session
            utils.try(dataCollectorGet.dropTempTables),
            utils.try(dataCollectorGet.commit),

            utils.tryAndMeasure(serializer.serializeData, 'serializer.serializeData')
        ],
        function (err, context) {
            return asyncDone(err, context);
        }
    );
};
