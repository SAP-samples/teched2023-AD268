'use strict';

const debug = require('debug');
const debugError = debug('xssec:JwksReplica');
debugError.log = console.error.bind(console);

const requests = require('../requests');
const nodeRSA = require('node-rsa');

class IdentityService {
    #url;
    #app_tid;           // optional zone id
    #oidcInfo;
    #clientId;

    get url() { return this.#url; }
    get app_tid() { return this.#app_tid; }
    get clientId() { return this.#clientId; }

    constructor(url, app_tid, client_id) {
        if (url === undefined) {
            throw new Error("IdentityService requires a url.");
        }

        this.#url = url;
        this.#app_tid = app_tid;
        this.#clientId = client_id;
    }

    async fetchOidcInfo() {
        return new Promise((res, rej) => {
            try {
                requests.requestOpenIDConfiguration(this.url, { clientId: this.clientId }, (err, oidcInfo) => {
                    if (err) {
                        return rej(err);
                    }

                    return res(oidcInfo);
                });
            } catch (e) {
                return rej(e);
            }
        });
    }

    async fetchJwks() {
        return new Promise(async (res, rej) => {
            if (!this.#oidcInfo) {
                try {
                    this.#oidcInfo = await this.fetchOidcInfo();
                } catch (e) {
                    return rej(e);
                }
            }

            const jwksEndpoint = this.#oidcInfo["jwks_uri"];

            try {
                requests.fetchOIDCKey(jwksEndpoint, this.app_tid, { clientId: this.clientId }, (err, json) => {
                    if (err) {
                        return rej(err);
                    }

                    const jwks = json.keys
                        .map(key => {
                            try {
                                const pem = this.createPem(key);
                                key.value = pem;
                            } catch(e) {
                                debugError(`Could not calculate PEM for key with kid ${key.kid}: ${e}. IdentityService: (${JSON.stringify(this)})`)
                            }

                            return key;
                        })
                        .filter(key => key.value !== undefined);
                    return res(jwks);
                });
            } catch (e) {
                return rej(e);
            }
        });
    }

    createPem(key) {
        if (key.kty !== "RSA") {
            throw new Error("KTY '" + key.kty + "' not supported");
        }

        const modulus = Buffer.from(key.n, 'base64');
        const exponent = Buffer.from(key.e, 'base64');

        const pubKey = new nodeRSA().importKey({ n: modulus, e: exponent }, 'components-public');
        return pubKey.exportKey('pkcs8-public-pem');
    }

    toJSON() {
        return {
            ...this,
            url: this.url,
            app_tid : this.app_tid,
            client_id: this.clientId
        }
    }
}

module.exports = IdentityService;