'use strict';

var assert = require('assert');
var hdbext = require('@sap/hdbext');
var connection = require('../xsjs/db/common/connection');

module.exports = SqlScriptJobRunner;


function SqlScriptJobRunner(dbReqOptions) {
  assert(dbReqOptions, 'Valid dbReqOptions expected');
  this._dbReqOptions = dbReqOptions;
}

SqlScriptJobRunner.prototype.run = async function(job, inputParams) {
  var self = this;
  var hanaOptions;
  var hdbClient;

  var hanaOpts = await this._dbReqOptions.getInstanceOptionsPromise();
  hanaOptions = hanaOpts;
  var client = await connection.connect(hanaOptions);
  hdbClient = client;
  client.setAutoCommit(true);
  var procedure = await hdbext.loadProcedurePromise(client, hanaOptions.schema, self._defineSqlProcName(job.action));
  await procedure(inputParams);
  hdbClient && await hdbClient.close();
};

SqlScriptJobRunner.prototype._defineSqlProcName = function(action) {
  if (!action.packagename) {
    return action.funcname;
  }

  return action.packagename + '::' + action.funcname;
};
